
# 微服务权限设计

## 业务权限的扩展究竟是本地扩展还是耦合到用户模块

发现问题的场景: 在学习优惠券模块的时候，发现优惠券模块有一个voucher_ops_tb表，表的格式如下:  

|字段名|数据类型|约束|描述|备注|
|:---:|:---:|:---:|:---:|:---:|
|**id**|bigint|pk notnull|||
|user_id|bigint|uk notnull|用户id||
|role|tinyint(1)|notnull|用户角色|0:op,1:admin,2:others|

...其他字段有点无关紧要就不放了  
这个表是优惠券模块中admin板块的业务表，它主要的作用是在op对优惠券进行一系列操作的时候进行权限校验使用的  
当时我看到这张表的时候，就觉得这个表是否是多余的，为什么不将权限统一的归属于用户模块进行管理？  
经过询问NorthSen以及询问AI之后，我了解了为什么业务权限的扩展要在本地而不是耦合到用户模块

## 1.代码都应该遵守单一职责的原则

正如标题，在java中，每一个类都应该遵守一个单一职责的原则，即这个类只需要管好自身的业务逻辑即可。  
每一个模块也不例外，每一个模块也可以类比成一个类，这个模块也要遵守单一职责的原则，否则整个项目就会显得非常的繁杂。  
如果将每一个模块的业务权限都耦合到用户模块的话，用户模块的职责就会非常的繁杂，用户模块的职责应该专注于用户核心身份的验证，  
也就是你登录的这个用户他的角色是什么，而不是拘泥于单一模块的业务细节权限。  

## 2.在公司代码的修改需要层层审批，极大浪费资源

如果将每一个模块的业务权限细节都耦合到用户模块，那么做一点细微的改动都需要进行汇报审批，一层一层往上，这其中浪费的时间和资源是不可估计的。

## 3.责任混淆不清

将每一个模块的业务权限细节耦合到用户模块的话，那么用户模块的程序员在对模块进行重构的时候可能会将这部分代码给删除或者修改，  
导致了相应模块的业务出现了问题，那么这时候就分不清这是谁的责任。  

## 4.灰度测试的问题

在公司中每一个模块进行修改之后，在本地测试完之后，需要发布**灰度测试**，所谓的**灰度测试**就是不将修改的代码发布到全部的实例中，而是选择一定比例。  
比如，发布10%的灰度测试就是在100台实例中选择10台将修改的代码发布到上面进行测试，如果将别的模块的业务权限细节耦合到用户模块的话，在进行灰度测试的时候，  
需要先将用户模块进行10%的灰度测试，再将相应模块进行10%的灰度测试，但是这时候是有90%的用户模块实例是旧代码，它们并不知道新业务权限代码的，所以这时候相应模块  
需要调用用户模块相应代码的时候可能会访问到那90%的实例去然后就会报错。

## 总结

在本地进行权限的扩展，第一它遵守了单一职责原则，这一整个模块都是干这个业务的，这样每一个模块的职责就划分的非常的清晰；  
第二因为是在本地代码进行扩展,进行修改的时候就不会有那么多审批，就不会浪费那么多的资源；  
3.在本地扩展出了问题该是谁的责任就是谁的不存在责任不清晰的问题；  
4.进行灰度测试的时候 新代码只会调用本地的业务权限细节，不会有访问不到的情况。


